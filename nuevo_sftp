#!/bin/bash

# --- Colores para mensajes ---
GREEN='\033[0;32m'
RED='\033[0;31m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# --- Validar que sea root ---
if [ "$EUID" -ne 0 ]; then
  echo -e "${RED}‚ùå Error: Este script debe ejecutarse como root (usa sudo).${NC}"
  exit 1
fi

echo -e "==========================================="
echo -e "   üõ†Ô∏è  CREADOR DE USUARIOS SFTP v2.0"
echo -e "==========================================="

# 1. Pedir nombre de usuario
read -p "Ingresa el nombre del nuevo usuario: " USER_NAME

if [ -z "$USER_NAME" ]; then
    echo -e "${RED}‚ùå El nombre no puede estar vac√≠o.${NC}"
    exit 1
fi

# Validar si ya existe
if id "$USER_NAME" &>/dev/null; then
    echo -e "${RED}‚ùå El usuario '$USER_NAME' ya existe.${NC}"
    exit 1
fi

# 2. L√≥gica de Contrase√±a (Manual o Autom√°tica)
echo -e "\n${YELLOW}üîë Contrase√±a:${NC}"
echo "   - Presiona ENTER para generar una aleatoria y segura."
echo "   - O escribe una contrase√±a manual."
read -s -p "Input: " USER_PASS_INPUT
echo "" # Salto de l√≠nea

if [ -z "$USER_PASS_INPUT" ]; then
    # Generar contrase√±a aleatoria (12 caracteres, alfanum√©rica + s√≠mbolos seguros)
    # Usamos openssl y filtramos un poco para evitar caracteres muy raros
    USER_PASS="Sftp.$(openssl rand -base64 8)!"
    echo -e "${CYAN}üîÑ Generando contrase√±a aleatoria...${NC}"
else
    # Si el usuario escribi√≥ algo, pedimos confirmaci√≥n
    read -s -p "Confirma la contrase√±a: " USER_PASS_CONFIRM
    echo ""
    
    if [ "$USER_PASS_INPUT" != "$USER_PASS_CONFIRM" ]; then
        echo -e "${RED}‚ùå Las contrase√±as no coinciden. Intenta de nuevo.${NC}"
        exit 1
    fi
    USER_PASS=$USER_PASS_INPUT
fi

# --- Verificar que exista el grupo ---
if ! getent group sftp_users > /dev/null; then
    echo -e "${YELLOW}‚ö†Ô∏è  El grupo 'sftp_users' no existe. Cre√°ndolo...${NC}"
    groupadd sftp_users
fi

# 3. Crear usuario
echo -e "\n‚è≥ Creando usuario en el sistema..."
useradd -m -G sftp_users -s /bin/false "$USER_NAME"
echo "$USER_NAME:$USER_PASS" | chpasswd

# 4. Estructura de Carpetas
BASE_DIR="/var/sftp/$USER_NAME"

echo "‚è≥ Configurando permisos y jaula..."

# A. Carpeta Ra√≠z (JAULA)
mkdir -p "$BASE_DIR"
chown root:root "$BASE_DIR"
chmod 755 "$BASE_DIR"

# B. Carpetas de Trabajo
mkdir -p "$BASE_DIR/staging"
mkdir -p "$BASE_DIR/curated"

# C. Permisos finales
chown "$USER_NAME":sftp_users "$BASE_DIR/staging"
chown "$USER_NAME":sftp_users "$BASE_DIR/curated"

# Obtener IP P√∫blica (Intento r√°pido, si falla muestra mensaje gen√©rico)
PUBLIC_IP=$(curl -s -m 2 ifconfig.me || echo "IP_DEL_SERVIDOR")

# --- RESUMEN FINAL PARA COPIAR ---
echo -e "\n"
echo -e "${GREEN}‚úÖ USUARIO CREADO CON √âXITO${NC}"
echo "------------------------------------------------------------"
echo " ‚úÇÔ∏è  COPIA Y PEGA ESTO PARA EL USUARIO  ‚úÇÔ∏è"
echo "------------------------------------------------------------"
echo "üìÇ DATOS DE CONEXI√ìN SFTP"
echo ""
echo "   Host/Servidor : $PUBLIC_IP"
echo "   Puerto        : 22"
echo "   Usuario       : $USER_NAME"
echo "   Contrase√±a    : $USER_PASS"
echo ""
echo "üìÇ RUTAS DISPONIBLES:"
echo "   /staging  -> Para subir archivos (Upload)"
echo "   /curated  -> Para descargar procesados (Download)"
echo "------------------------------------------------------------"
echo -e "${YELLOW}‚ö†Ô∏è  Nota: Guarda esta contrase√±a, no se podr√° ver despu√©s.${NC}"
echo ""