#!/bin/bash

# --- Colores para mensajes ---
GREEN='\033[0;32m'
RED='\033[0;31m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# --- Validar que sea root ---
if [ "$EUID" -ne 0 ]; then
  echo -e "${RED}‚ùå Error: Este script debe ejecutarse como root (usa sudo).${NC}"
  exit 1
fi

# ==========================================
#  FUNCIONES DEL SISTEMA
# ==========================================

# --- FUNCI√ìN 1: CREAR USUARIO ---
crear_usuario() {
    echo -e "\n${CYAN}--- CREAR NUEVO USUARIO SFTP ---${NC}"
    
    # 1. Pedir nombre
    read -p "Ingresa el nombre del nuevo usuario: " USER_NAME

    if [ -z "$USER_NAME" ]; then
        echo -e "${RED}‚ùå El nombre no puede estar vac√≠o.${NC}"
        return
    fi

    # Validar si ya existe
    if id "$USER_NAME" &>/dev/null; then
        echo -e "${RED}‚ùå El usuario '$USER_NAME' ya existe.${NC}"
        return
    fi

    # 2. Contrase√±a
    echo -e "\n${YELLOW}üîë Contrase√±a:${NC}"
    echo "   - Presiona ENTER para generar una aleatoria."
    echo "   - O escribe una manual."
    read -s -p "Input: " USER_PASS_INPUT
    echo "" 

    if [ -z "$USER_PASS_INPUT" ]; then
        USER_PASS="Sftp.$(openssl rand -base64 8)!"
        echo -e "${CYAN}üîÑ Generando contrase√±a aleatoria...${NC}"
    else
        read -s -p "Confirma la contrase√±a: " USER_PASS_CONFIRM
        echo ""
        if [ "$USER_PASS_INPUT" != "$USER_PASS_CONFIRM" ]; then
            echo -e "${RED}‚ùå Las contrase√±as no coinciden.${NC}"
            return
        fi
        USER_PASS=$USER_PASS_INPUT
    fi

    # Verificar grupo
    if ! getent group sftp_users > /dev/null; then
        echo -e "${YELLOW}‚ö†Ô∏è  El grupo 'sftp_users' no existe. Cre√°ndolo...${NC}"
        groupadd sftp_users
    fi

    # 3. Crear usuario
    echo -e "‚è≥ Creando usuario..."
    useradd -m -G sftp_users -s /bin/false "$USER_NAME"
    echo "$USER_NAME:$USER_PASS" | chpasswd

    # 4. Carpetas y Permisos
    BASE_DIR="/var/sftp/$USER_NAME"
    mkdir -p "$BASE_DIR"
    chown root:root "$BASE_DIR"
    chmod 755 "$BASE_DIR"

    mkdir -p "$BASE_DIR/staging"
    mkdir -p "$BASE_DIR/curated"
    chown "$USER_NAME":sftp_users "$BASE_DIR/staging"
    chown "$USER_NAME":sftp_users "$BASE_DIR/curated"

    # Resumen
    PUBLIC_IP=$(curl -s -m 2 ifconfig.me || echo "IP_DEL_SERVIDOR")
    echo -e "\n${GREEN}‚úÖ USUARIO CREADO${NC}"
    echo "------------------------------------------------------------"
    echo " ‚úÇÔ∏è  DATOS PARA EL CLIENTE  ‚úÇÔ∏è"
    echo "------------------------------------------------------------"
    echo "   Host       : $PUBLIC_IP"
    echo "   Usuario    : $USER_NAME"
    echo "   Contrase√±a : $USER_PASS"
    echo "------------------------------------------------------------"
    echo -e "${YELLOW}‚ö†Ô∏è  Guarda la contrase√±a, no se mostrar√° de nuevo.${NC}"
    
    # Pausa para leer
    read -p "Presiona Enter para volver al men√∫..."
}

# --- FUNCI√ìN 2: DESACTIVAR USUARIO ---
desactivar_usuario() {
    echo -e "\n${RED}--- DESACTIVAR USUARIO (BLOQUEAR ACCESO) ---${NC}"
    read -p "Nombre del usuario a bloquear: " USER_NAME

    # Validaciones
    if [ -z "$USER_NAME" ]; then echo -e "${RED}‚ùå Nombre vac√≠o.${NC}"; return; fi
    if ! id "$USER_NAME" &>/dev/null; then echo -e "${RED}‚ùå El usuario no existe.${NC}"; return; fi

    # Acci√≥n: Lock password
    usermod -L "$USER_NAME"
    
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}‚úÖ El usuario '$USER_NAME' ha sido desactivado.${NC}"
        echo "   (Su contrase√±a ha sido bloqueada, pero sus archivos siguen ah√≠)."
    else
        echo -e "${RED}‚ùå Error al desactivar usuario.${NC}"
    fi
    read -p "Presiona Enter para continuar..."
}

# --- FUNCI√ìN 3: REACTIVAR USUARIO ---
reactivar_usuario() {
    echo -e "\n${GREEN}--- REACTIVAR USUARIO (DESBLOQUEAR) ---${NC}"
    read -p "Nombre del usuario a reactivar: " USER_NAME

    if [ -z "$USER_NAME" ]; then echo -e "${RED}‚ùå Nombre vac√≠o.${NC}"; return; fi
    if ! id "$USER_NAME" &>/dev/null; then echo -e "${RED}‚ùå El usuario no existe.${NC}"; return; fi

    # Acci√≥n: Unlock password
    usermod -U "$USER_NAME"

    if [ $? -eq 0 ]; then
        echo -e "${GREEN}‚úÖ El usuario '$USER_NAME' ha sido reactivado.${NC}"
        echo "   (Ahora puede volver a conectarse con su contrase√±a anterior)."
    else
        echo -e "${RED}‚ùå Error al reactivar usuario.${NC}"
    fi
    read -p "Presiona Enter para continuar..."
}

# ==========================================
#  MEN√ö PRINCIPAL
# ==========================================
while true; do
    clear
    echo -e "==========================================="
    echo -e "   üõ†Ô∏è  GESTOR DE USUARIOS SFTP v3.0"
    echo -e "==========================================="
    echo "1. Crear nuevo usuario"
    echo "2. Desactivar usuario (Lock)"
    echo "3. Reactivar usuario (Unlock)"
    echo "4. Salir"
    echo "-------------------------------------------"
    read -p "Elige una opci√≥n: " opc

    case $opc in
        1) crear_usuario ;;
        2) desactivar_usuario ;;
        3) reactivar_usuario ;;
        4) echo "Adi√≥s üëã"; exit 0 ;;
        *) echo -e "${RED}Opci√≥n inv√°lida.${NC}"; sleep 1 ;;
    esac
done
