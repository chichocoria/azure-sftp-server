#!/bin/bash

# --- Configuraci√≥n de Logs ---
LOG_FILE="/var/log/sftp_manager.log"

# --- Colores ---
GREEN='\033[0;32m'
RED='\033[0;31m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# --- Validar Root ---
if [ "$EUID" -ne 0 ]; then
  echo -e "${RED}‚ùå Error: Este script debe ejecutarse como root (sudo).${NC}"
  exit 1
fi

# ==========================================
#  SISTEMA DE LOGS
# ==========================================
# Funci√≥n interna para escribir en el archivo de log
registrar_evento() {
    local TIPO=$1
    local MENSAJE=$2
    local FECHA=$(date '+%Y-%m-%d %H:%M:%S')
    # Formato: [FECHA] [TIPO] Mensaje
    echo "[$FECHA] [$TIPO] $MENSAJE" >> "$LOG_FILE"
}

# Crear el archivo de log si no existe
if [ ! -f "$LOG_FILE" ]; then
    touch "$LOG_FILE"
    chmod 640 "$LOG_FILE"
    registrar_evento "SYSTEM" "Archivo de log inicializado."
fi

# ==========================================
#  FUNCIONES DE GESTI√ìN
# ==========================================

# 1. CREAR USUARIO
crear_usuario() {
    echo -e "\n${CYAN}--- CREAR NUEVO USUARIO SFTP ---${NC}"
    read -p "Nombre del usuario: " USER_NAME

    if [ -z "$USER_NAME" ]; then echo -e "${RED}‚ùå Nombre vac√≠o.${NC}"; return; fi
    if id "$USER_NAME" &>/dev/null; then echo -e "${RED}‚ùå Ya existe.${NC}"; return; fi

    # Contrase√±a
    echo -e "${YELLOW}üîë Contrase√±a (Enter para autom√°tica):${NC}"
    read -s -p "Input: " USER_PASS_INPUT
    echo "" 

    if [ -z "$USER_PASS_INPUT" ]; then
        USER_PASS="Sftp.$(openssl rand -base64 8)!"
    else
        read -s -p "Confirma: " USER_PASS_CONFIRM
        echo ""
        if [ "$USER_PASS_INPUT" != "$USER_PASS_CONFIRM" ]; then
            echo -e "${RED}‚ùå No coinciden.${NC}"; return
        fi
        USER_PASS=$USER_PASS_INPUT
    fi

    # Grupo
    if ! getent group sftp_users > /dev/null; then
        groupadd sftp_users
        registrar_evento "SYSTEM" "Grupo sftp_users creado."
    fi

    # Creaci√≥n
    echo "‚è≥ Creando..."
    useradd -m -G sftp_users -s /bin/false "$USER_NAME"
    echo "$USER_NAME:$USER_PASS" | chpasswd

    # Carpetas
    BASE_DIR="/var/sftp/$USER_NAME"
    mkdir -p "$BASE_DIR/staging" "$BASE_DIR/curated"
    chown root:root "$BASE_DIR"
    chmod 755 "$BASE_DIR"
    chown "$USER_NAME":sftp_users "$BASE_DIR/staging" "$BASE_DIR/curated"

    # Log y Salida
    registrar_evento "CREATE" "Usuario creado: $USER_NAME"
    
    PUBLIC_IP=$(curl -s -m 2 ifconfig.me || echo "IP_DEL_SERVIDOR")
    echo -e "\n${GREEN}‚úÖ USUARIO CREADO${NC}"
    echo "------------------------------------------------"
    echo " Host: $PUBLIC_IP | User: $USER_NAME | Pass: $USER_PASS"
    echo "------------------------------------------------"
    read -p "Enter para volver..."
}

# 2. DESACTIVAR
desactivar_usuario() {
    echo -e "\n${RED}--- BLOQUEAR USUARIO ---${NC}"
    read -p "Usuario a bloquear: " USER_NAME
    if ! id "$USER_NAME" &>/dev/null; then echo -e "${RED}‚ùå No existe.${NC}"; return; fi

    usermod -L "$USER_NAME"
    registrar_evento "LOCK" "Usuario bloqueado: $USER_NAME"
    echo -e "${GREEN}‚úÖ Usuario $USER_NAME bloqueado.${NC}"
    read -p "Enter para volver..."
}

# 3. REACTIVAR
reactivar_usuario() {
    echo -e "\n${GREEN}--- DESBLOQUEAR USUARIO ---${NC}"
    read -p "Usuario a desbloquear: " USER_NAME
    if ! id "$USER_NAME" &>/dev/null; then echo -e "${RED}‚ùå No existe.${NC}"; return; fi

    usermod -U "$USER_NAME"
    registrar_evento "UNLOCK" "Usuario desbloqueado: $USER_NAME"
    echo -e "${GREEN}‚úÖ Usuario $USER_NAME reactivado.${NC}"
    read -p "Enter para volver..."
}

# 4. LIMPIAR CARPETAS (NUEVO)
limpiar_carpetas() {
    echo -e "\n${YELLOW}--- üßπ LIMPIAR ARCHIVOS DE USUARIO ---${NC}"
    echo "Esto borrar√° TODO el contenido en /staging y /curated del usuario."
    read -p "Nombre del usuario objetivo: " USER_NAME

    if ! id "$USER_NAME" &>/dev/null; then echo -e "${RED}‚ùå El usuario no existe.${NC}"; return; fi

    # Confirmaci√≥n de seguridad
    echo -e "${RED}‚ö†Ô∏è  ¬°ATENCI√ìN! ESTA ACCI√ìN ES IRREVERSIBLE.${NC}"
    read -p "¬øEst√°s seguro de borrar los archivos de $USER_NAME? (s/n): " CONFIRM

    if [[ "$CONFIRM" == "s" || "$CONFIRM" == "S" ]]; then
        echo "‚è≥ Borrando archivos..."
        
        # Borramos contenido, pero no la carpeta en s√≠
        rm -rf /var/sftp/"$USER_NAME"/staging/*
        rm -rf /var/sftp/"$USER_NAME"/curated/*
        
        # Log del evento
        registrar_evento "DELETE_FILES" "Archivos eliminados para el usuario: $USER_NAME"
        
        echo -e "${GREEN}‚úÖ Limpieza completada.${NC}"
    else
        echo "‚ùå Operaci√≥n cancelada."
    fi
    read -p "Enter para volver..."
}

# 5. CREAR ADMIN
crear_admin() {
    echo -e "\n${CYAN}--- CREAR ADMIN (SUPERVISOR) ---${NC}"
    read -p "Nombre admin: " ADMIN_NAME
    if id "$ADMIN_NAME" &>/dev/null; then echo -e "${RED}‚ùå Ya existe.${NC}"; return; fi
    
    read -s -p "Password: " P1; echo ""
    read -s -p "Confirmar: " P2; echo ""
    
    if [ "$P1" != "$P2" ]; then echo "No coinciden"; return; fi

    useradd -m -s /bin/bash -G sudo "$ADMIN_NAME"
    echo "$ADMIN_NAME:$P1" | chpasswd
    
    registrar_evento "CREATE_ADMIN" "Administrador creado: $ADMIN_NAME"
    echo -e "${GREEN}‚úÖ Admin creado.${NC}"
    read -p "Enter para volver..."
}

# ==========================================
#  MEN√ö PRINCIPAL
# ==========================================
while true; do
    clear
    echo -e "==========================================="
    echo -e "   üõ†Ô∏è  GESTOR SFTP v5.0 (Con Logs)"
    echo -e "==========================================="
    echo "1. Crear Cliente SFTP"
    echo "2. Bloquear Cliente (Lock)"
    echo "3. Desbloquear Cliente (Unlock)"
    echo "4. Crear Administrador"
    echo -e "${YELLOW}5. Limpiar archivos de usuario (Borrar)${NC}"
    echo "6. Ver Logs (√öltimos 10 eventos)"
    echo "7. Salir"
    echo "-------------------------------------------"
    read -p "Opci√≥n: " opc

    case $opc in
        1) crear_usuario ;;
        2) desactivar_usuario ;;
        3) reactivar_usuario ;;
        4) crear_admin ;;
        5) limpiar_carpetas ;;
        6) echo ""; tail -n 10 "$LOG_FILE"; read -p "Enter..." ;;
        7) exit 0 ;;
        *) echo "Opci√≥n inv√°lida." ;;
    esac
done
